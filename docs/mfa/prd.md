# `bs_server` 增强身份认证（EIA）需求文档

**文档版本**：1.0
**日期**：2026-02-25
**负责人**：[您的名字]

## 1. 项目背景与目标

随着系统安全需求的提升，传统的静态密码认证已不足以应对日益复杂的网络安全威胁。为了在不牺牲用户体验的前提下增强账户安全性，本项目旨在引入一套自适应的增强身份认证（Enhanced Identity Authentication, EIA）机制，其核心为多因素认证（MFA）。

**核心目标**：

1.  **提升账户安全性**：通过引入第二验证因素，有效防止因密码泄露导致的未授权访问。
2.  **优化用户体验**：采用基于风险的自适应策略，仅在必要时要求用户进行额外验证，避免对低风险用户造成干扰。
3.  **构建可扩展框架**：系统需支持未来快速接入多种验证方式（如短信、邮件、硬件密钥等）。

## 2. 功能范围 (Scope)

| 核心功能                | 优先级 | 描述                                                         |
| :---------------------- | :----- | :----------------------------------------------------------- |
| **F-01**: 风险评估登录  | **高** | 用户登录时，系统评估其环境风险。                             |
| **F-02**: 分阶段认证    | **高** | 根据风险评估结果，执行单阶段或多阶段认证流程。               |
| **F-03**: TOTP 验证支持 | **高** | 实现基于时间的一次性密码（TOTP）作为首个支持的第二验证因素。 |
| **F-04**: 认证状态管理  | **高** | 通过令牌（Token）管理用户的认证进度与权限状态。              |
| **F-05**: 插件化验证器  | **中** | 建立可插拔的验证器（Provider）框架，便于未来扩展。           |

## 3. 用户故事 (User Stories)

- **作为一名普通用户**：
    - **U-01**: 当我在常用设备和网络环境下登录时，我希望能和以前一样，仅凭用户名密码就能直接访问系统，而不会被额外的验证步骤打扰。
    - **U-02**: 当系统检测到我的账户在新设备或不熟悉的地区登录时，我希望能收到需要进行二次验证的提示，以确保我的账户安全。
- **作为一名系统管理员**：
    - **U-03**: 我希望未来能够为系统快速增加新的验证方式（例如短信验证），而不需要对核心认证流程进行大规模重构。

## 4. 详细功能需求 (Functional Requirements)

### FR-01: 风险评估与登录决策

- **FR-1.1**: 用户登录接口（`/login`）在验证密码成功后，必须调用风险评估服务。
- **FR-1.2**: 风险评估服务应至少包含以下基础判定逻辑：
    - **IP 地址**：判断当前登录 IP 是否与用户上一次登录 IP 一致。
    - （未来扩展：新设备指纹、登录频率等）
- **FR-1.3**: 根据风险评估结果，系统执行以下决策：
    - **低风险**：返回标准的 `accessToken`，用户直接登录。
    - **高风险**：返回一个“受限 `accessToken`”，并告知客户端需要进行 MFA 验证。

### FR-02: 分阶段认证流程

- **FR-2.1**: **受限令牌**：该令牌在 JWT `Claims` 中必须包含 `MFAPending: true` 和 `RequiredType` 字段。
- **FR-2.2**: **中间件拦截**：所有业务 API 接口（除认证相关接口外）的请求，必须通过一个中间件进行检查。
    - 若请求携带的令牌为“受限令牌”，则必须拒绝访问，并返回特定错误码（如 `403 MFA_REQUIRED`）。
- **FR-2.3**: **二次验证接口**：必须提供一个独立的二次验证接口（如 `/login/mfa-verify`），用于处理用户提交的 MFA 验证码。
- **FR-2.4**: **令牌置换**：用户成功通过二次验证后，系统必须作废其“受限令牌”，并颁发一个具有完整权限的“正式令牌”。

### FR-03: 认证器框架

- **FR-3.1**: 必须定义一个 `MFAProvider` 接口，包含 `GetID()` 和 `Verify()` 等核心方法。
- **FR-3.2**: 基于该接口，实现一个 `TOTPProvider` 作为首个验证器。
- **FR-3.3**: 认证服务内部应维护一个 `MFAProvider` 的注册表（`map`），以便根据 `RequiredType` 动态调用相应的验证器。

## 5. 非功能性需求 (Non-Functional Requirements)

- **NFR-01 (安全性)**：
    - MFA 验证码必须是一次性的，且在验证成功后立即失效。
    - “受限令牌”的有效期应被严格限制（如 5-10 分钟）。
- **NFR-02 (可扩展性)**：添加新的 MFA 验证方式（如 `SMSProvider`）不应修改核心登录流程与中间件逻辑，仅需实现并注册新的 `Provider`。
- **NFR-03 (性能)**：风险评估逻辑的执行时间不应显著增加登录接口的响应时间。

## 6. 验收标准 (Acceptance Criteria)

1.  **低风险场景**：在同一 IP 地址多次登录，用户输入正确的用户名密码后应直接进入系统。
2.  **高风险场景**：更换 IP 地址后首次登录，输入正确的用户名密码后，访问业务接口应被拒绝，并提示需要 MFA 验证。
3.  **验证流程**：在高风险场景下，输入正确的 TOTP 验证码后，系统应能正常访问。
4.  **扩展性验证**：代码审查时，需证明添加一个虚拟的 `EmailProvider` 的流程是清晰且低耦合的。
